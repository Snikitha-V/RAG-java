<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RAG Chat</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    #chat { max-width:800px; margin:auto; }
    .msg { padding:8px; border-radius:6px; margin:6px 0; }
    .user { background:#dff0ff; text-align:right; }
    .bot { background:#f4f4f8; }
    .meta { color:#666; font-size:12px; }
    #controls { margin-top:12px; display:flex; gap:8px; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>RAG Chat</h2>
    <div id="messages"></div>
    <div id="controls">
      <input id="query" style="flex:1" placeholder="Ask something..." />
      <button id="send">Send</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <script>
    const messages = document.getElementById('messages');
    const queryInput = document.getElementById('query');

    async function sendQuery() {
      const q = queryInput.value.trim();
      if (!q) return;
      appendMessage(q, 'user');
      queryInput.value = '';
      appendMessage('…thinking…', 'bot', true);
      try {
        const res = await fetch('/api/v1/query', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({query: q})
        });
        const json = await res.json();
        removeThinking();
        if (json.answer) {
          appendMessage(json.answer, 'bot');
          if (json.sources) appendMeta('Sources: ' + json.sources);
        } else {
          appendMessage('No answer', 'bot');
        }
      } catch (e) {
        removeThinking();
        appendMessage('Error: ' + e.message, 'bot');
      }
    }

    function appendMessage(text, cls, thinking=false) {
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      div.innerText = text;
      if (thinking) div.dataset.thinking = '1';
      messages.appendChild(div);
      window.scrollTo(0,document.body.scrollHeight);
    }
    function removeThinking() {
      const t = document.querySelector('.msg[data-thinking]');
      if (t) t.remove();
    }
    function appendMeta(text) {
      const div = document.createElement('div');
      div.className = 'meta';
      div.innerText = text;
      messages.appendChild(div);
    }

    document.getElementById('send').onclick = sendQuery;
    queryInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendQuery();});
    document.getElementById('reset').onclick = ()=>{ messages.innerHTML=''; appendMessage('Conversation reset.','bot'); };
  </script>
</body>
</html>
